{% extends 'dashboard_base.html' %}

{% block title %}Veloce | Factura {{ factura.invoice_num }}{% endblock %}

{% block dashboard_content %}
<div class="container-fluid p-2 p-md-3" id="factura-container">
    
    <!-- Header Mobile -->
    <div class="d-block d-md-none mb-3">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
                <a href="{{ url_for('factura.listar_facturas') }}" class="btn btn-sm btn-outline-primary mb-2">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h2 class="h5 fw-bold text-secondary mb-1">Factura {{ factura.invoice_num }}</h2>
                <span class="badge {% if factura.estado == 'Pagada' %}bg-success{% elif factura.estado == 'Pendiente' %}bg-warning{% else %}bg-secondary{% endif %}">
                    {{ factura.estado }} hola
                </span>
            </div>
        </div>
    </div>

    <!-- Header Desktop -->
    <div class="d-none d-md-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('factura.listar_facturas') }}">Facturas</a></li>
                    <li class="breadcrumb-item active">Factura {{ factura.invoice_num }}</li>
                </ol>
            </nav>
            <h2 class="h4 fw-bold text-secondary mb-0">Detalle de Factura</h2>
        </div>
        
        <div class="btn-group">
            <button onclick="window.print()" class="btn btn-outline-secondary">
                <i class="fas fa-print me-1"></i> Imprimir
            </button>
            <button onclick="generarPDF()" class="btn btn-primary" id="btn-pdf">
                <i class="fas fa-download me-1"></i> PDF
            </button>
            <a href="{{ url_for('factura.listar_facturas') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-1"></i> Volver
            </a>
        </div>
    </div>

    <!-- Botones de Acción Mobile -->
    <div class="d-block d-md-none mb-3">
        <div class="row g-2">
            <div class="col-4">
                <button onclick="window.print()" class="btn btn-outline-secondary w-100 btn-sm">
                    <i class="fas fa-print"></i>
                </button>
            </div>
            <div class="col-4">
                <button onclick="generarPDF()" class="btn btn-primary w-100 btn-sm" id="btn-pdf-mobile">
                    <i class="fas fa-download"></i>
                </button>
            </div>
            <div class="col-4">
                <a href="{{ url_for('factura.listar_facturas') }}" class="btn btn-outline-primary w-100 btn-sm">
                    <i class="fas fa-list"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Tarjeta de Factura -->
    <div class="card shadow-sm mb-3" id="factura-card">
        <div class="card-header bg-white border-bottom p-3">
            <!-- Mobile Header -->
            <div class="d-block d-md-none text-center">
                <div class="mb-2">
                    {% if organizacion.logo and organizacion.logo.startswith('http') %}
                    <img src="{{ organizacion.logo }}" 
                         alt="Logo" 
                         style="max-height: 60px; object-fit: contain;"
                         onerror="this.style.display='none'">
                    {% else %}
                    <img src="{{ url_for('static', filename='image/' ~ organizacion.logo) }}" 
                         alt="Logo" 
                         style="max-height: 60px; object-fit: contain;"
                         onerror="this.style.display='none'">
                    {% endif %}
                </div>
                <h3 class="h6 fw-bold text-primary mb-1">FACTURA</h3>
                <p class="text-muted small mb-0">N° {{ factura.invoice_num }}</p>
                <p class="text-muted small mb-0">Emitida: {{ factura.fecha_emision if factura.fecha_emision else factura.fecha }}</p>
            </div>
            
            <!-- Desktop Header -->
            <div class="d-none d-md-block">
                <div class="row align-items-center">
                    <div class="col-md-6 d-flex align-items-center">
                        <div class="me-3 pe-3 border-end">
                            {% if organizacion.logo and organizacion.logo.startswith('http') %}
                            <img src="{{ organizacion.logo }}" 
                                 alt="Logo" 
                                 style="max-height: 70px; max-width: 180px; object-fit: contain;"
                                 onerror="this.src='{{ url_for('static', filename='image/default_logo.png') }}'">
                            {% else %}
                            <img src="{{ url_for('static', filename='image/' ~ organizacion.logo) }}" 
                                 alt="Logo" 
                                 style="max-height: 70px; max-width: 180px; object-fit: contain;"
                                 onerror="this.src='{{ url_for('static', filename='image/default_logo.png') }}'">
                            {% endif %}
                        </div>
                        <div>
                            <h3 class="h5 fw-bold text-primary mb-1">FACTURA</h3>
                            <p class="text-muted mb-0 fs-5">N° {{ factura.invoice_num }}</p>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <span class="badge {% if factura.estado == 'Pagada' %}bg-success{% elif factura.estado == 'Pendiente' %}bg-warning{% else %}bg-secondary{% endif %} fs-6 mb-2">
                            {{ factura.estado }} 
                        </span>
                        <p class="text-muted mb-0">Emitida: <strong>{{ factura.fecha_emision.strftime('%d/%m/%Y') if factura.fecha_emision else factura.fecha }}</strong></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card-body p-2 p-md-4">
            <!-- Información de Empresa y Cliente -->
            <div class="row mb-3">
                <!-- Emisor -->
                <div class="col-12 col-md-6 mb-3">
                    <div class="border rounded p-2 p-md-3 h-100">
                        <h3 class="fw-bold text-primary mb-2 ">EMISOR</h3>
                        <div class="mb-1">
                            <strong class="text-secondary small">Veloce Systems</strong>
                        </div>
                        <div class="text-muted" style="font-size: 0.8rem;">
                            <div class="mb-1"><h6><strong>Org:</strong> {{ organizacion.nombre }}</h6></div>
                            <div class="mb-1"><h6><strong>Vendedor:</strong> {{ factura.vendedor }}</h6></div>
                            <div class="mb-1"><h6><strong>RNC:</strong> {{ organizacion.rnc }}</h6></div>
                            <div class="mb-1"><h6><strong>Tel:</strong> {{ organizacion.telefono }}</h6></div>
                            <div><h6><strong>Email:</strong> {{ organizacion.email }}</h6></div>
                        </div>
                    </div>
                </div>
                
                <!-- Cliente -->
                <div class="col-12 col-md-6 mb-3">
                    <div class="border rounded p-2 p-md-3 h-100">
                        <h3 class="fw-bold text-primary mb-2 ">CLIENTE</h3>
                        <div class="mb-2">
                            <h5 class="fw-bold text-dark mb-0">{{ factura.cliente.nombre }} {{ factura.cliente.apellido }}</h5>
                        </div>
                        <div class="text-muted" style="font-size: 0.8rem;">
                            <div class="mb-1">
                                <i class="fas fa-id-card me-1" style="width: 16px;"></i>
                                <strong>Identificación:</strong> {{ factura.cliente.identificacion or 'No registrada' }}
                            </div>
                            {% if factura.cliente.telefono %}
                            <div class="mb-1">
                                <i class="fas fa-phone me-1" style="width: 16px;"></i>
                                <strong>Tel:</strong> {{ factura.cliente.telefono }}
                            </div>
                            {% endif %}
                            {% if factura.cliente.correo %}
                            <div class="mb-1">
                                <i class="fas fa-envelope me-1" style="width: 16px;"></i>
                                {{ factura.cliente.correo }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items de la Factura - Vista Mobile -->
            <div class="d-block d-md-none">
                <h6 class="fw-bold text-primary mb-2">ITEMS</h6>
                {% for item in factura.items %}
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <strong class="text-dark small">{{ loop.index }}. {{ item.descripcion }}</strong>
                    </div>
                    <div class="row small text-muted">
                        <div class="col-4">
                            <strong>Cant:</strong> {{ item.cantidad }}
                        </div>
                        <div class="col-4 text-center">
                            <strong>P.Unit:</strong> {{ organizacion.moneda or 'RD$' }} {{ "%.2f"|format(item.precio_unitario) }}
                        </div>
                        <div class="col-4 text-end">
                            <strong>Total:</strong> {{ organizacion.moneda or 'RD$' }} {{ "%.2f"|format(item.precio_unitario * item.cantidad) }}
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Total Mobile -->
                <div class="border-top pt-2 mt-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong class="text-dark">TOTAL FACTURA:</strong>
                        <span class="fw-bold text-success fs-6">{{ organizacion.moneda or 'RD$' }} {{ "%.2f"|format(factura.total) }}</span>
                    </div>
                </div>
            </div>

            <!-- Items de la Factura - Vista Desktop -->
            <div class="d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm" id="tabla-items">
                        <thead class="bg-light">
                            <tr>
                                <th width="5%" class="text-center">#</th>
                                <th width="50%">Descripción</th>
                                <th width="15%" class="text-center">Cantidad</th>
                                <th width="15%" class="text-end">P. Unitario</th>
                                <th width="15%" class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in factura.items %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>
                                <td>{{ item.descripcion }}</td>
                                <td class="text-center">{{ item.cantidad }}</td>
                                <td class="text-end">{{ organizacion.moneda or 'RD$' }} {{ "%.2f"|format(item.precio_unitario) }}</td>
                                <td class="text-end fw-bold">{{ organizacion.moneda or 'RD$' }} {{ "%.2f"|format(item.precio_unitario * item.cantidad) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-active">
                                <td colspan="4" class="text-end fw-bold">TOTAL:</td>
                                <td class="text-end fw-bold text-success fs-5">{{ organizacion.moneda or 'RD$' }} {{ "%.2f"|format(factura.total) }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Información de Vencimiento -->
            <div class="mt-3 pt-2 border-top">
                <div class="row">
                    <div class="col-12 col-md-6 mb-1">
                        <small class="text-muted">
                            <strong>Condiciones:</strong> 30 días<br>
                            <strong>Método de Pago:</strong> {{ factura.forma_pago|capitalize if factura.forma_pago else 'Efectivo' }}
                        </small>
                    </div>
                    <div class="col-12 col-md-6 text-md-end">
                        <small class="text-muted">
                            <strong>Vencimiento:</strong> A 30 días
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones de Factura -->
    <div class="card shadow-sm">
        <div class="card-body p-2 p-md-3">
            <!-- Mobile Actions -->
            <div class="d-block d-md-none">
                <div class="row g-2">
                    <div class="col-4">
                        <a href="#" 
                           class="btn btn-outline-success w-100 btn-sm">
                            <i class="fas fa-edit"></i>
                        </a>
                    </div>
                    <div class="col-4">
                        <form method="POST" action="#" class="d-inline w-100">
                            <input type="hidden" name="estado" value="Pagada">
                            <button type="submit" 
                                    class="btn {% if factura.estado == 'Pagada' %}btn-outline-secondary{% else %}btn-outline-primary{% endif %} w-100 btn-sm">
                                <i class="fas fa-check-circle"></i>
                            </button>
                        </form>
                    </div>
                    <div class="col-4">
                        <button onclick="confirmarEliminacion()" class="btn btn-outline-danger w-100 btn-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="row g-2 mt-1">
                    <div class="col-6">
                        <small class="text-center d-block text-muted">Editar</small>
                    </div>
                    <div class="col-6">
                        <small class="text-center d-block text-muted">
                            {% if factura.estado == 'Pagada' %}Pagada{% else %}Pagar{% endif %}
                        </small>
                    </div>
                </div>
            </div>

            <!-- Desktop Actions -->
            <div class="d-none d-md-block">
                <div class="row g-3">
                    <div class="col-md-4">
                        <a href="{{url_for('factura.editar_factura', factura_id=factura.id)}}" 
                           class="btn btn-outline-success w-100">
                            <i class="fas fa-edit me-1"></i> Editar Factura
                        </a>
                    </div>
                    <div class="col-md-4">
                        <form method="POST" action="{{ url_for('factura.marcar_pago', factura_id=factura.id) }}" class="d-inline w-100">
                            <input type="hidden" name="estado" value="Pagada">
                            <button type="submit" 
                                    class="btn {% if factura.estado == 'Pagada' %}btn-outline-secondary{% else %}btn-outline-primary{% endif %} w-100">
                                <i class="fas fa-check-circle me-1"></i> 
                                {% if factura.estado == 'Pagada' %}Pagada{% else %}Marcar como Pagada{% endif %}
                            </button>
                        </form>
                    </div>
                    <div class="col-md-4">
                        <button onclick="confirmarEliminacion()" class="btn btn-outline-danger w-100">
                            <i class="fas fa-trash me-1"></i> Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación PDF -->
<div class="modal fade" id="pdfModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Descargar PDF</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Descargar factura {{ factura.invoice_num }} en PDF?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="descargarPDF()">Descargar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación Eliminación -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Eliminar Factura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger">⚠️ ¿Estás seguro de eliminar la factura {{ factura.invoice_num }}?</p>
                <p class="text-muted small">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="#" class="d-inline">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

function generarPDF() {
    $('#pdfModal').modal('show');
}

function descargarPDF() {
    const btn = document.getElementById('btn-pdf');
    const btnMobile = document.getElementById('btn-pdf-mobile');
    
    // Mostrar loading en ambos botones
    if (btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>';
        btn.disabled = true;
    }
    if (btnMobile) {
        btnMobile.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btnMobile.disabled = true;
    }
    
    // Elemento a convertir
    const element = document.getElementById('factura-card');
    const opt = {
        margin: [5, 5, 5, 5],
        filename: 'factura_{{ factura.invoice_num }}.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
            scale: 2,
            useCORS: true,
            logging: false
        },
        jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait' 
        }
    };
    
    // Generar PDF
    html2pdf().set(opt).from(element).save().then(() => {
        // Restaurar botones
        if (btn) {
            btn.innerHTML = '<i class="fas fa-download me-1"></i> PDF';
            btn.disabled = false;
        }
        if (btnMobile) {
            btnMobile.innerHTML = '<i class="fas fa-download"></i>';
            btnMobile.disabled = false;
        }
        $('#pdfModal').modal('hide');
    });
}

function confirmarEliminacion() {
    $('#deleteModal').modal('show');
}

// Mejorar experiencia táctil
document.addEventListener('DOMContentLoaded', function() {
    // Aumentar área táctil en móviles
    if (window.innerWidth < 768) {
        const buttons = document.querySelectorAll('.btn');
        buttons.forEach(btn => {
            btn.style.minHeight = '44px';
            btn.style.padding = '10px 8px';
        });
    }
});
</script>

<style>
/* Estilos Mobile First */
#factura-card {
    background: white;
}

/* Mejoras para móviles */
@media (max-width: 767.98px) {
    .container-fluid {
        padding-left: 8px;
        padding-right: 8px;
    }
    
    .card-body {
        padding: 1rem !important;
    }
    
    .btn {
        min-height: 44px; /* Tamaño táctil mínimo */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-sm {
        min-height: 38px;
        padding: 8px 6px;
    }
    
    /* Mejorar legibilidad en móviles */
    .text-muted {
        font-size: 0.75rem;
    }
    
    .small {
        font-size: 0.8rem;
    }
    
    /* Espaciado optimizado para móviles */
    .mb-3 {
        margin-bottom: 1rem !important;
    }
    
    .p-2 {
        padding: 0.75rem !important;
    }
}

/* Estilos para tablets */
@media (min-width: 768px) and (max-width: 991.98px) {
    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }
    
    .card-body {
        padding: 1.5rem !important;
    }
}

/* Estilos para impresión */
@media print {
    .breadcrumb, .btn-group, .card:not(#factura-card), 
    .modal, .fixed-bottom, .d-print-none {
        display: none !important;
    }
    
    body {
        background: white !important;
        font-size: 12pt;
        padding: 0 !important;
    }
    
    .container-fluid {
        padding: 0 !important;
        max-width: 100% !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
        margin: 0 !important;
    }
    
    .table-bordered {
        border: 1px solid #000 !important;
    }
    
    .table-bordered th, .table-bordered td {
        border: 1px solid #000 !important;
        padding: 4pt;
    }
    
    .text-primary {
        color: #000 !important;
    }
    
    .badge {
        border: 1px solid #000;
        background: white !important;
        color: #000 !important;
    }
}

/* Mejoras de legibilidad */
.bg-light {
    background-color: #f8f9fa !important;
}

.table-sm th, .table-sm td {
    padding: 0.5rem;
}

/* Asegurar que los textos no se desborden */
.text-truncate-mobile {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

@media (max-width: 767.98px) {
    .text-truncate-mobile {
        white-space: normal;
        word-wrap: break-word;
    }
}
</style>
{% endblock %}